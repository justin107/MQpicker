var MqPicker=function(setting){this.param={domMaster:null,placeholderText:'请输入省/市/区',layPosition:'float',layerWidth:500,searchName:'中国',lastIsMultiple:false,pickerClass:'pickerArea',pickerLevel:{name:['省','市','区'],},separator:'，',areaSeparator:'、',output:'value',};$.extend(this.param,setting);this.domMaster=$(this.param.domMaster);this.levelNum=this.param.pickerLevel.name.length;this.param.areaType=this.param.lastIsMultiple?'checkbox':'radio';this.onceLoad=true;this.isLastDom=false;this.tabData=[];this.rndNum=Math.random().toString(36).substr(2);this.tabHeadVal='0';this.outName='';this.outValue='';this.init()};$.extend(MqPicker.prototype,{init:function(){var self=this;self.initData();self.initDom()},initDom:function(){var self=this,inputChildItem=[],tabHeadChildItem=[],tabBoxChildItem=[],innterHtml='';for(var i=0;i<self.levelNum;i++){inputChildItem.push('<span index="'+i+'" class="input-area-item input-area-item-'+i+'"></span>');if(i===0){tabHeadChildItem.push('<div index="'+i+'" class="tab-head tab-head-'+i+'"><label><input checked name="tab-head-radio-'+self.rndNum+'" type="radio" value='+i+'><span>'+self.param.pickerLevel.name[i]+'</span></label></div>')}else{tabHeadChildItem.push('<div index="'+i+'" class="tab-head tab-head-'+i+'"><label><input name="tab-head-radio-'+self.rndNum+'" type="radio" value='+i+'><span>'+self.param.pickerLevel.name[i]+'</span></label></div>')}tabBoxChildItem.push('<div index="'+i+'" class="tab-pane tab-pane-'+i+'"><div class="tab-pane-box"><p class="no-data">暂无数据</p></div></div>')}var inputHtml=['<div class="aMap-picker-input-box">','<i class="ico-arrow"></i>','<span class="input-placeholder">'+self.param.placeholderText+'</span>','<div class="input-area">'].concat(inputChildItem,['</div>','</div>']).join('');var tabStr="aMap-picker-tab-"+self.rndNum;var tabHtml=['<div class="aMap-picker-tab '+tabStr+'">','<div class="aMap-picker-tab-head">'].concat(tabHeadChildItem,['</div>'],['<div class="aMap-picker-tab-pane">'],tabBoxChildItem,['</div>']).join('');var buttons=['<div class="aMap-picker-tab-buttons">','<div class="aMap-picker-tab-box">','<span class="aMap-btn-submit">确定</span>','<span class="aMap-btn-choose-all">全选</span>','<span class="aMap-btn-cancel">取消</span>','</div>','</div>'].join('');if(self.param.layPosition==='float'){innterHtml=inputHtml+tabHtml+buttons+'</div>';self.domMaster.html(innterHtml);self.domMaster.find('.aMap-picker-tab').addClass('aMap-picker-tab-float')}else if(self.param.layPosition==='layer'){innterHtml=inputHtml+'</div>';self.domMaster.html(innterHtml);$('body').addClass('aMap-picker-tab-out').append(tabHtml+buttons);self.layerDom=$('.'+tabStr);self.layerDom.addClass("aMap-picker-tab-layer").css('width',self.param.layerWidth+'px')}else{innterHtml=inputHtml+tabHtml+buttons+'</div>';self.domMaster.html(innterHtml)}self.domMaster.addClass('aMap-picker-area');if(self.param.layPosition!=='layer'){self.tabDom=self.domMaster.find('.aMap-picker-tab')}else{self.tabDom=self.layerDom}self.initEvent()},initData:function(){var self=this;self.tabHeadVal='0';for(var i=0;i<self.levelNum;i++){self.tabData[i]={name:'',value:"",data:[]};if(self.param.lastIsMultiple){self.tabData[self.levelNum-1]={name:[],value:[],data:[]}}}},initEvent:function(){var self=this,levelNum=self.levelNum,lastIndex=levelNum-1,lastData=self.tabData[lastIndex];if(self.param.pickerClass!=='pickerPost'){self.pickerSearch(self.param.searchName)}else{}if(self.param.layPosition!=='layer'){$(document).mousedown(function(e){if($(e.target).parents(".aMap-picker-area").length===0){self.domMaster.find('.aMap-picker-tab').hide();self.isPlaceholder();self.domMaster.find('.ico-arrow').removeClass('activeMove')}})}else{$(document).mousedown(function(e){if($(e.target).parents(".aMap-picker-tab").length===0&&$(e.target).parents(".aMap-picker-tab-layer").length===0){self.tabDom.hide();self.isPlaceholder();self.domMaster.find('.ico-arrow').removeClass('activeMove')}})}self.domMaster.on('click','.input-area',function(){self.tabDom.show();self.domMaster.find('.ico-arrow').addClass('activeMove')});self.tabDom.on('change',"input[name='tab-head-radio-"+self.rndNum+"']",function(){self.tabHeadVal=$(this).val();self.tabDom.find('.tab-pane-'+self.tabHeadVal).show().siblings().hide();self.isShowButtons()});for(var i=0;i<levelNum;i++){self.tabDom.on("click","input[type='radio'][name='tabLabel-area-"+i+"-"+self.rndNum+"']",function(){var labelName=$(this).siblings().text(),labelVal=$(this).val();var inputItem=self.domMaster.find('.input-area-item-'+self.tabHeadVal+'');if(self.tabHeadVal==0){inputItem.html(labelName)}else{inputItem.html(self.param.separator+labelName)}var index=$(this).parents('.tab-pane').attr('index')*1,nextIndex=index+1+'';if(lastIndex!=index){$("input[name='tab-head-radio-"+self.rndNum+"'][value="+nextIndex+"]").prop('checked',true).change();if(labelName!==self.tabData[index].name){self.tabData[index].name=labelName;self.tabData[index].value=labelVal;self.domMaster.find('.input-area-item-'+index).nextAll().html('');var level=$(this).parent().attr('level');if(self.param.pickerClass==='pickerAreaPost'&&level==="city"){self.param.loadAjax({name:labelName}).done(function(data){console.log("数据",data.data);self.updateArea(data.data)})}else{self.pickerSearch(labelName);}}for(var m=nextIndex;m<levelNum;m++){self.tabData[m].name='';self.tabData[m].value=''}if(self.param.lastIsMultiple&&lastIndex+1===levelNum){self.tabData[nextIndex].name=[];self.tabData[nextIndex].value=[]}}else{self.tabData[index].name=labelName;self.tabData[index].value=labelVal}self.isShowButtons();self.isPlaceholder()})}self.tabDom.on("click","input[type='checkbox'][name='tabLabel-area-"+lastIndex+"-"+self.rndNum+"']",function(){var arrayName=[],arrayVal=[],_that=$(this),checked=_that.data().checked,checkedName=_that.next().text(),checkedVal=_that.val();if(!checked){_that.data().checked=true;self.tabData[lastIndex].name.push(checkedName);self.tabData[lastIndex].value.push(checkedVal)}else{_that.data().checked=false;arrayName=self.tabData[self.levelNum-1].name.filter(function(item){return item!=checkedName});arrayVal=self.tabData[self.levelNum-1].value.filter(function(item){return item!=checkedVal});self.tabData[self.levelNum-1].name=arrayName;self.tabData[self.levelNum-1].value=arrayVal}var lastInputItem=self.domMaster.find('.input-area-item:last');if(self.tabData[self.levelNum-1].name.length!==0){var arrayAreaStr=self.tabData[self.levelNum-1].name.join(self.param.areaSeparator);if(lastIndex===0){lastInputItem.html('<em title='+arrayAreaStr+'>'+arrayAreaStr+'</em>')}else{lastInputItem.html('<em title='+arrayAreaStr+'>'+self.param.separator+arrayAreaStr+'</em>')}}else{lastInputItem.html('')}self.isShowButtons();self.isPlaceholder()});self.tabDom.on("click",'.aMap-btn-choose-all',function(){self.tabDom.find(".tab-pane:last input[type='checkbox']").prop('checked',true).change().data({checked:true});self.tabData[lastIndex].value=[];self.tabData[lastIndex].name=[];var lastDom=self.tabDom.find('div.tab-pane:last');lastDom.find("input[type='checkbox']").each(function(){if($(this).is(':checked')){self.tabData[lastIndex].value.push($(this).val());self.tabData[lastIndex].name.push($(this).next().text())}});var lastInputItem=self.domMaster.find('.input-area-item:last');if(lastIndex!==0){lastInputItem.html(self.param.separator+self.tabData[lastIndex].name.join(self.param.areaSeparator))}else{lastInputItem.html(self.tabData[lastIndex].name.join(self.param.areaSeparator))}$(this).hide().siblings('.aMap-btn-cancel').show();});self.tabDom.on("click",'.aMap-btn-cancel',function(){self.tabDom.find(".tab-pane:last input[type='checkbox']").prop('checked',false).change().data({checked:false});self.outClear();self.tabData[lastIndex].name=[];self.tabData[lastIndex].value=[];self.domMaster.find('.input-area-item:last').html('');$(this).hide().siblings('.aMap-btn-choose-all').show();self.isPlaceholder()});self.tabDom.on("click",'.aMap-btn-submit',function(){console.log('tabData',self.tabData);self.outClear();if(self.param.output==='value'){if(self.param.lastIsMultiple){self.outValue=lastData.value.join(self.param.separator)}else{self.outValue=lastData.value}}else if(self.param.output==='name'){if(self.param.lastIsMultiple){self.outName=lastData.name.join(self.param.separator)}else{self.outName=lastData.name}}self.tabDom.hide()})},outClear:function(){var self=this;self.outValue="";self.outName=""},isShowButtons:function(){var self=this,buttons=self.tabDom.find('.aMap-picker-tab-buttons'),chooseAll=self.tabDom.find('.aMap-btn-choose-all'),cancelAll=self.tabDom.find('.aMap-btn-cancel'),lastData=self.tabData[self.levelNum-1];self.isLastDom=self.levelNum===(self.tabHeadVal*1+1)?true:false;if(self.isLastDom){if(self.param.lastIsMultiple){lastData.name.length===0?buttons.hide():buttons.show();if(lastData.name.length===lastData.data.length){cancelAll.show();chooseAll.hide()}else{cancelAll.hide();chooseAll.show()}}else{chooseAll.hide();cancelAll.hide();lastData.name!=''?buttons.show():buttons.hide()}}else{buttons.hide()}},isPlaceholder:function(){var self=this,placeholder=self.domMaster.find('.input-placeholder');if(self.tabDom.find('.tab-pane-box :checked').length===0){placeholder.show()}else{placeholder.hide()}},pickerSearch:function(name,indexEdit,editArray){var self=this;var districtListNext,index=indexEdit*1||self.tabHeadVal*1,indexData=self.tabData[index],val=name||indexData.value;window.districtSearch.search(val,function(status,result){if(status=='complete'&&result.districtList.length===1){districtListNext=result.districtList[0].districtList;var thisLevel=result.districtList[0].level;if(thisLevel=='country'&&self.onceLoad){indexData.data=districtListNext;self.updateProvince(districtListNext)}else{if(indexEdit){self.updateArea(districtListNext,indexEdit,editArray[index])}else{self.updateArea(districtListNext)}}}else{console.log(status,result);if(self.param.pickerErrors){self.param.pickerErrors()}else{alert('返回错误!')}self.pickerReset();}})},updateProvince:function(data){var self=this,specialCityList=[],provinceList=[],provinceData=data;self.onceLoad=false;sortChinese(provinceData,'name');provinceData.forEach(function(item,index){if(item.adcode==="450000"){item.name='广西';item.letter='G'}else if(item.adcode==="650000"){item.name='新疆';item.letter='X'}else if(item.adcode==="540000"){item.name='西藏';item.letter='X'}else if(item.adcode==="640000"){item.name='宁夏';item.letter='N'}else if(item.adcode==="810000"){item.name='香港';item.letter='X'}else if(item.adcode==="150000"){item.name='内蒙古';item.letter='N'}else if(item.adcode==="820000"){item.name='澳门';item.letter='A'}else if(item.adcode==="230000"){item.name='黑龙江';item.letter='H'}else if(item.adcode==="340000"){item.letter='A'}else if(item.adcode==="110000"){item.letter='B'}else if(item.adcode==="500000"){item.letter='C'}else if(item.adcode==="350000"){item.letter='F'}else if(item.adcode==="620000"){item.letter='G'}else if(item.adcode==="440000"){item.letter='G'}else if(item.adcode==="520000"){item.letter='G'}else if(item.adcode==="460000"){item.letter='H'}else if(item.adcode==="130000"){item.letter='H'}else if(item.adcode==="410000"){item.letter='H'}else if(item.adcode==="420000"){item.letter='H'}else if(item.adcode==="430000"){item.letter='H'}else if(item.adcode==="220000"){item.letter='J'}else if(item.adcode==="320000"){item.letter='J'}else if(item.adcode==="360000"){item.letter='J'}else if(item.adcode==="210000"){item.letter='L'}else if(item.adcode==="630000"){item.letter='Q'}else if(item.adcode==="370000"){item.letter='S'}else if(item.adcode==="140000"){item.letter='S'}else if(item.adcode==="610000"){item.letter='S'}else if(item.adcode==="310000"){item.letter='S'}else if(item.adcode==="510000"){item.letter='S'}else if(item.adcode==="710000"){item.letter='T'}else if(item.adcode==="120000"){item.letter='T'}else if(item.adcode==="530000"){item.letter='Y'}else if(item.adcode==="330000"){item.letter='Z'}if(isString(item.citycode)){specialCityList.push(item)}else{provinceList.push(item)}});specialCityList.sort(function(a,b){return(a.citycode)*1-(b.citycode)*1});self.renderProvince(provinceList,specialCityList)},renderProvince:function(dataA,dataB){var self=this,alphabet=['A','F','G','H','J','L','N','Q','S','X','Y','Z'];var htmlChild=[],htmlChildStr;for(var i=0;i<alphabet.length;i++){var dataSame=dataA.filter(function(value){return value.letter==alphabet[i]});var interHtml=[];for(var n=0;n<dataSame.length;n++){var provinceName=dataSame[n].name;if(provinceName.length===2){provinceName='<i class="space-letter">'+provinceName+'</i>'}else{provinceName='<i>'+provinceName+'</i>'}interHtml.push('<label><input name="tabLabel-area-'+self.tabHeadVal+'-'+self.rndNum+'" type="radio" value='+dataSame[n].adcode+'><span>'+provinceName+'</span></label>')}var outerHtml=['<dl>','<dt name='+alphabet[i]+'>',alphabet[i],'</dt>','<dd>','</dd>','</dl>'];outerHtml.splice(5,0,interHtml.join(''));htmlChild.push(outerHtml.join(''))}var cities=[],cityStr;dataB.forEach(function(item,index){var cityName=item.name;if(cityName.length===2){cityName='<i class="space-letter">'+cityName+'</i>'}else{cityName='<i>'+cityName+'</i>'}if(item.adcode*1<710000){cities.push('<label><input name="tabLabel-area-'+self.tabHeadVal+'-'+self.rndNum+'" type="radio" value='+item.adcode+'><span>'+cityName+'</span></label>')}else{cities.push('<label title="未开通地区"><input name="tabLabel-area-'+self.tabHeadVal+'-'+self.rndNum+'" disabled type="radio" value='+item.adcode+'><span>'+cityName+'</span></label>')}});cityStr='<dl class="special-city">'+'<dt>'+'</dt>'+'<dd>'+cities.join('')+'</dd>'+'</dl>';htmlChildStr=cityStr+htmlChild.join('');var provinceDom=self.tabDom.find('.tab-pane:first').addClass('tab-pane-province').find('.tab-pane-box');provinceDom.html(htmlChildStr)},updateArea:function(data,indexEdit,val){var self=this;var areaData=data,index=indexEdit*1||self.tabHeadVal*1,indexData=self.tabData[index];areaData.sort(function(a,b){return a.name.length-b.name.length});if(self.param.pickerClass==='pickerPost'||self.param.pickerClass==='pickerAreaPost'){areaData.forEach(function(item){item.adcode=item.value;item.level=item.level||""})}indexData.data=areaData;self.renderArea(areaData,indexEdit,val);console.log(areaData)},renderArea:function(data,indexEdit,val){var self=this;var index=indexEdit*1||self.tabHeadVal*1;var areaDom=self.tabDom.find('.tab-pane-'+index);self.domMaster.find('.tab-head-'+index+' input').prop('checked',true).change();areaDom.show().siblings().hide();var interHtml=[];self.isLastDom=self.levelNum===(index+1)?true:false;if(self.isLastDom){if(self.param.areaType==='radio'){for(var i=0;i<data.length;i++){interHtml.push('<label><input name="tabLabel-area-'+index+'-'+self.rndNum+'" type="radio" value='+data[i].adcode+'><span>'+data[i].name+'</span></label>')}}else{for(var i=0;i<data.length;i++){interHtml.push('<label><input name="tabLabel-area-'+index+'-'+self.rndNum+'" type="checkbox" value='+data[i].adcode+'><span>'+data[i].name+'</span></label>')}}}else{for(var i=0;i<data.length;i++){interHtml.push('<label level='+data[i].level+'><input name="tabLabel-area-'+index+'-'+self.rndNum+'" type="radio" value='+data[i].adcode+'><span>'+data[i].name+'</span></label>')}}areaDom.find('.tab-pane-box').html(interHtml.join(''));if(self.isLastDom&&self.param.lastIsMultiple){$('.tab-pane:last input[type="checkbox"]').data({checked:false})}if(indexEdit){if(self.param.lastIsMultiple&&self.isLastDom){let textArray=[];for(var i=0;i<val.length;i++){let checkeds=self.tabDom.find("[name='tabLabel-area-"+index+"-"+self.rndNum+"'][value='"+val[i]+"']")checkeds.prop('checked',true).data({checked:true});textArray.push(checkeds.siblings().text())}self.domMaster.find('.input-area-item').eq(index).html(self.param.separator+textArray.join(self.param.areaSeparator));self.tabData[index].value=val;self.tabData[index].name=textArray}else{self.tabDom.find("[name='tabLabel-area-"+index+"-"+self.rndNum+"'][value='"+val+"']").prop('checked',true);var text=self.tabDom.find("[name='tabLabel-area-"+index+"-"+self.rndNum+"'][value='"+val+"']").siblings().text();self.domMaster.find('.input-area-item').eq(index).html(self.param.separator+text);self.tabData[index].value=val;self.tabData[index].name=text}}},pickerReset:function(){var self=this;self.tabDom.find('input').prop('checked',false);self.tabDom.find('.tab-head:first input').prop('checked',true).change();self.tabDom.find('.tab-pane:first').show().siblings().find('.tab-pane-box').html('<p class="no-data">暂无数据</p>');self.initData();self.domMaster.find('.aMap-picker-tab-buttons').hide();self.domMaster.find('.input-area-item').html("");self.domMaster.find('.input-placeholder').show()},pickerRewrite(array){var self=this;self.pickerReset()console.log(array);self.domMaster.find('.input-placeholder').hide();self.tabDom.find("[name='tabLabel-area-0-"+self.rndNum+"'][value='"+array[0]+"']").prop('checked',true);var text=self.tabDom.find("[name='tabLabel-area-0-"+self.rndNum+"'][value='"+array[0]+"']").siblings().text();self.domMaster.find('.input-area-item').eq(0).html(text);self.tabData[0].value=array[0];self.tabData[0].name=text;self.pickerSearch(array[0],1,array);self.pickerSearch(array[1],2,array)},postAjax:function(callback){},getValue:function(){}});function sortChinese(arr,dataLeven){function getValue(option){if(!dataLeven)return option;var data=option dataLeven.split('.').filter(function(item){data=data[item]})return data+''}arr.sort(function(a,b){return getValue(a).localeCompare(getValue(b),'zh-CN')});arr.sort(function(a,b){return(a.adcode)*1-(b.adcode)*1})}function isString(str){return(typeof str=='string')&&str.constructor===String}//})